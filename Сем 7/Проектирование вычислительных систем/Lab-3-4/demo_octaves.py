#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã –æ–∫—Ç–∞–≤
"""

import serial
import time
import sys

def demo_octaves(port='COM3'):
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–∫—Ç–∞–≤"""
    print("=" * 60)
    print("üéµ –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –û–ö–¢–ê–í")
    print("=" * 60)
    print("\n–û–∫—Ç–∞–≤–∞ - —ç—Ç–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª, –≥–¥–µ —á–∞—Å—Ç–æ—Ç–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –≤ 2 —Ä–∞–∑–∞")
    print("'+' = –∑–≤—É–∫ –≤—ã—à–µ (—á–∞—Å—Ç–æ—Ç–∞ √ó 2)")
    print("'-' = –∑–≤—É–∫ –Ω–∏–∂–µ (—á–∞—Å—Ç–æ—Ç–∞ √∑ 2)")
    print("=" * 60)

    try:
        ser = serial.Serial(port, 115200, timeout=1)
        time.sleep(2)
        print(f"\n‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ {port}\n")

        # –ß–∏—Ç–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        time.sleep(0.5)
        while ser.in_waiting > 0:
            ser.readline()

        print("\n" + "=" * 60)
        print("–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø 1: –ü–æ–¥—ä–µ–º –ø–æ –æ–∫—Ç–∞–≤–∞–º")
        print("=" * 60)
        print("\n–°–µ–π—á–∞—Å –ø—Ä–æ–∑–≤—É—á–∏—Ç –Ω–æ—Ç–∞ '–î–æ' –≤ —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ç–∞–≤–∞—Ö:")
        print("–û—Ç –Ω–∏–∑–∫–æ–π (—Å—É–±–∫–æ–Ω—Ç—Ä–æ–∫—Ç–∞–≤–∞) –¥–æ –≤—ã—Å–æ–∫–æ–π (–ø—è—Ç–∞—è –æ–∫—Ç–∞–≤–∞)\n")

        input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –Ω–∞—á–∞–ª–∞...")

        # –°–±—Ä–æ—Å –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –æ–∫—Ç–∞–≤—É
        print("\n1. –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –æ–∫—Ç–∞–≤—É...")
        for _ in range(5):
            ser.write(b'-')
            time.sleep(0.1)
        time.sleep(0.5)

        # –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º "–î–æ" –≤ –∫–∞–∂–¥–æ–π –æ–∫—Ç–∞–≤–µ, –ø–æ–¥–Ω–∏–º–∞—è—Å—å –≤–≤–µ—Ä—Ö
        octave_names = [
            "–°—É–±–∫–æ–Ω—Ç—Ä–æ–∫—Ç–∞–≤–∞ (–æ—á–µ–Ω—å –Ω–∏–∑–∫–æ)",
            "–ö–æ–Ω—Ç—Ä–æ–∫—Ç–∞–≤–∞ (–Ω–∏–∑–∫–æ)",
            "–ë–æ–ª—å—à–∞—è –æ–∫—Ç–∞–≤–∞",
            "–ú–∞–ª–∞—è –æ–∫—Ç–∞–≤–∞",
            "–ü–µ—Ä–≤–∞—è –æ–∫—Ç–∞–≤–∞ (–Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)",
            "–í—Ç–æ—Ä–∞—è –æ–∫—Ç–∞–≤–∞",
            "–¢—Ä–µ—Ç—å—è –æ–∫—Ç–∞–≤–∞",
            "–ß–µ—Ç–≤–µ—Ä—Ç–∞—è –æ–∫—Ç–∞–≤–∞",
            "–ü—è—Ç–∞—è –æ–∫—Ç–∞–≤–∞ (–æ—á–µ–Ω—å –≤—ã—Å–æ–∫–æ)"
        ]

        frequencies = [32.70, 65.41, 130.81, 261.63, 261.63, 523.26, 1046.50, 2093.00, 4186.01]

        for i, (name, freq) in enumerate(zip(octave_names, frequencies)):
            print(f"\n{i}. {name}")
            print(f"   –ß–∞—Å—Ç–æ—Ç–∞: {freq:.2f} –ì—Ü")
            ser.write(b'1')  # –ò–≥—Ä–∞—Ç—å "–î–æ"
            time.sleep(1.2)

            if i < len(octave_names) - 1:
                ser.write(b'+')  # –£–≤–µ–ª–∏—á–∏—Ç—å –æ–∫—Ç–∞–≤—É
                time.sleep(0.3)

        print("\n" + "=" * 60)
        print("–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø 2: –ì–∞–º–º–∞ –≤ —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ç–∞–≤–∞—Ö")
        print("=" * 60)
        print("\n–°–µ–π—á–∞—Å –ø—Ä–æ–∑–≤—É—á–∏—Ç –≥–∞–º–º–∞ –≤ —Ç—Ä–µ—Ö —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ç–∞–≤–∞—Ö:")
        print("–ù–∏–∑–∫–∞—è ‚Üí –°—Ä–µ–¥–Ω—è—è ‚Üí –í—ã—Å–æ–∫–∞—è\n")

        input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è...")

        # –í–æ–∑–≤—Ä–∞—Ç –∫ –ø–µ—Ä–≤–æ–π –æ–∫—Ç–∞–≤–µ (—Å—Ä–µ–¥–Ω–µ–π)
        print("\n–í–æ–∑–≤—Ä–∞—Ç –∫ –ø–µ—Ä–≤–æ–π –æ–∫—Ç–∞–≤–µ...")
        for _ in range(4):
            ser.write(b'-')
            time.sleep(0.1)
        time.sleep(0.5)

        # 1. –ú–∞–ª–∞—è –æ–∫—Ç–∞–≤–∞ (–Ω–∏–∑–∫–∞—è)
        print("\n1. –ú–∞–ª–∞—è –æ–∫—Ç–∞–≤–∞ (–Ω–∏–∑–∫–∞—è –≥–∞–º–º–∞):")
        ser.write(b'-')
        time.sleep(0.3)
        for note in '1234567':
            ser.write(note.encode())
            time.sleep(0.4)
        time.sleep(0.5)

        # 2. –ü–µ—Ä–≤–∞—è –æ–∫—Ç–∞–≤–∞ (—Å—Ä–µ–¥–Ω—è—è)
        print("\n2. –ü–µ—Ä–≤–∞—è –æ–∫—Ç–∞–≤–∞ (—Å—Ä–µ–¥–Ω—è—è –≥–∞–º–º–∞):")
        ser.write(b'+')
        time.sleep(0.3)
        for note in '1234567':
            ser.write(note.encode())
            time.sleep(0.4)
        time.sleep(0.5)

        # 3. –í—Ç–æ—Ä–∞—è –æ–∫—Ç–∞–≤–∞ (–≤—ã—Å–æ–∫–∞—è)
        print("\n3. –í—Ç–æ—Ä–∞—è –æ–∫—Ç–∞–≤–∞ (–≤—ã—Å–æ–∫–∞—è –≥–∞–º–º–∞):")
        ser.write(b'+')
        time.sleep(0.3)
        for note in '1234567':
            ser.write(note.encode())
            time.sleep(0.4)
        time.sleep(0.5)

        print("\n" + "=" * 60)
        print("–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø 3: –≠—Ñ—Ñ–µ–∫—Ç —Å–º–µ–Ω—ã –æ–∫—Ç–∞–≤—ã")
        print("=" * 60)
        print("\n–ü–æ–ø–µ—Ä–µ–º–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–∫—Ç–∞–≤ –Ω–∞ –æ–¥–Ω–æ–π –Ω–æ—Ç–µ\n")

        input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è...")

        # –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–µ—Ä–≤–æ–π –æ–∫—Ç–∞–≤–µ
        ser.write(b'-')
        time.sleep(0.3)

        print("\n–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø–µ—Ä–≤–æ–π –∏ –≤—Ç–æ—Ä–æ–π –æ–∫—Ç–∞–≤–æ–π:")
        for i in range(5):
            print(f"\n  –†–∞–∑ {i+1}:")
            print("    –ü–µ—Ä–≤–∞—è –æ–∫—Ç–∞–≤–∞ (–Ω–∏–∑–∫–æ)")
            ser.write(b'1')
            time.sleep(0.5)

            ser.write(b'+')  # –í–≤–µ—Ä—Ö
            time.sleep(0.2)

            print("    –í—Ç–æ—Ä–∞—è –æ–∫—Ç–∞–≤–∞ (–≤—ã—Å–æ–∫–æ)")
            ser.write(b'1')
            time.sleep(0.5)

            ser.write(b'-')  # –í–Ω–∏–∑
            time.sleep(0.2)

        print("\n" + "=" * 60)
        print("–ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–´–ô –†–ï–ñ–ò–ú")
        print("=" * 60)
        print("\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–∞–º–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å!")
        print("\n–ö–æ–º–∞–Ω–¥—ã:")
        print("  1-7  : –ò–≥—Ä–∞—Ç—å –Ω–æ—Ç—ã (–î–æ, –†–µ, –ú–∏, –§–∞, –°–æ–ª—å, –õ—è, –°–∏)")
        print("  +    : –û–∫—Ç–∞–≤–∞ –≤–≤–µ—Ä—Ö (–∑–≤—É–∫ –≤—ã—à–µ)")
        print("  -    : –û–∫—Ç–∞–≤–∞ –≤–Ω–∏–∑ (–∑–≤—É–∫ –Ω–∏–∂–µ)")
        print("  quit : –í—ã—Ö–æ–¥")
        print()

        while True:
            cmd = input(">>> ").strip()

            if cmd.lower() in ['quit', 'exit', 'q']:
                break

            for char in cmd:
                ser.write(char.encode())
                time.sleep(0.05)

            # –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç
            time.sleep(0.1)
            while ser.in_waiting > 0:
                data = ser.readline()
                try:
                    msg = data.decode('utf-8', errors='ignore').strip()
                    if msg:
                        print(f"STM32: {msg}")
                except:
                    pass

        print("\n‚úÖ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")

    except serial.SerialException as e:
        print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")
        sys.exit(1)
    except KeyboardInterrupt:
        print("\n\n‚ö†Ô∏è  –ü—Ä–µ—Ä–≤–∞–Ω–æ")
    finally:
        if 'ser' in locals() and ser.is_open:
            ser.close()
            print("–û—Ç–∫–ª—é—á–µ–Ω–æ\n")


if __name__ == "__main__":
    if len(sys.argv) > 1:
        port = sys.argv[1]
    else:
        port = input("–í–≤–µ–¥–∏—Ç–µ COM-–ø–æ—Ä—Ç (–∏–ª–∏ Enter –¥–ª—è COM3): ").strip()
        if not port:
            port = 'COM3'

    demo_octaves(port)
